<!-- request-trip-enhanced.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุทูุจ ุฑุญูุฉ - ุชุฑุญุงู</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/map-styles.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <div class="enhanced-trip-container">
        <!-- Header -->
        <header class="trip-header">
            <button class="back-btn" onclick="window.history.back()">โ</button>
            <h1>ุทูุจ ุฑุญูุฉ ุฌุฏูุฏุฉ</h1>
            <div class="location-status" id="locationStatus">
                <span class="status-icon">๐</span>
                <span id="locationStatusText">ุฌุงุฑู ุชุญุฏูุฏ ุงููููุน...</span>
            </div>
        </header>

        <main class="trip-main">
            <!-- ุงูุฎุฑูุทุฉ -->
            <div class="map-section">
                <div id="tripMap" class="trip-map"></div>
                <div class="map-controls">
                    <button class="btn-locate" id="locateMeBtn">
                        <span>๐</span>
                        <span>ูููุนู ุงูุญุงูู</span>
                    </button>
                    <button class="btn-secondary" id="selectOnMapBtn">
                        <span>๐บ๏ธ</span>
                        <span>ุงุฎุชุฑ ุนูู ุงูุฎุฑูุทุฉ</span>
                    </button>
                </div>
            </div>

            <!-- ุชูุงุตูู ุงูุฑุญูุฉ -->
            <div class="trip-details">
                <div class="location-inputs">
                    <div class="input-group pickup-group">
                        <label for="pickupInput">๐ ูููุน ุงูุงูุทูุงู</label>
                        <div class="input-with-icon">
                            <input type="text" id="pickupInput" 
                                   placeholder="ูููุนู ุงูุญุงูู" readonly>
                            <button class="btn-clear" id="clearPickupBtn">โ</button>
                        </div>
                        <div class="location-accuracy" id="pickupAccuracy">
                            ุฏูุฉ ุงููููุน: <span id="accuracyValue">--</span> ูุชุฑ
                        </div>
                    </div>

                    <div class="input-group destination-group">
                        <label for="destinationInput">๐ ุงููุฌูุฉ</label>
                        <div class="input-with-icon">
                            <input type="text" id="destinationInput" 
                                   placeholder="ุฃูู ุชุฑูุฏ ุงูุฐูุงุจุ">
                            <button class="btn-search" id="searchDestinationBtn">๐</button>
                        </div>
                        <div class="suggestions" id="destinationSuggestions"></div>
                    </div>
                </div>

                <!-- ูุชุงุฆุฌ ุงูุจุญุซ -->
                <div class="search-results" id="searchResults" style="display: none;">
                    <h3>ูุชุงุฆุฌ ุงูุจุญุซ:</h3>
                    <div class="results-list" id="resultsList"></div>
                </div>

                <!-- ูุนูููุงุช ุงูุฑุญูุฉ -->
                <div class="trip-info-card" id="tripInfo" style="display: none;">
                    <h3>ุชูุงุตูู ุงูุฑุญูุฉ</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span>ุงููุณุงูุฉ:</span>
                            <span id="tripDistance">-- ูู</span>
                        </div>
                        <div class="info-item">
                            <span>ุงูููุช ุงููุชููุน:</span>
                            <span id="tripDuration">-- ุฏูููุฉ</span>
                        </div>
                        <div class="info-item">
                            <span>ุงูุชูููุฉ ุงูุชูุฏูุฑูุฉ:</span>
                            <span id="tripFare">-- SDG</span>
                        </div>
                    </div>
                </div>

                <!-- ุงุฎุชูุงุฑ ููุน ุงูุณูุงุฑุฉ -->
                <div class="car-selection">
                    <h3>ุงุฎุชุฑ ููุน ุงูุณูุงุฑุฉ:</h3>
                    <div class="car-options">
                        <div class="car-option active" data-type="standard">
                            <div class="car-icon">๐</div>
                            <div class="car-info">
                                <div class="car-name">ุนุงุฏู</div>
                                <div class="car-price">3,000 SDG</div>
                            </div>
                            <div class="car-selected">โ</div>
                        </div>
                        <div class="car-option" data-type="comfort">
                            <div class="car-icon">๐</div>
                            <div class="car-info">
                                <div class="car-name">ูุฑูุญ</div>
                                <div class="car-price">4,500 SDG</div>
                            </div>
                            <div class="car-selected">โ</div>
                        </div>
                        <div class="car-option" data-type="van">
                            <div class="car-icon">๐</div>
                            <div class="car-info">
                                <div class="car-name">ูุงู</div>
                                <div class="car-price">6,000 SDG</div>
                            </div>
                            <div class="car-selected">โ</div>
                        </div>
                    </div>
                </div>

                <!-- ุทูุจ ุงูุฑุญูุฉ -->
                <div class="request-section">
                    <button class="btn-primary btn-large btn-request" id="requestTripBtn" disabled>
                        <span class="btn-icon">๐</span>
                        <span class="btn-text">ุทูุจ ุฑุญูุฉ ุจู <span id="finalFare">3,000</span> SDG</span>
                    </button>
                    
                    <div class="request-note">
                        <p>๐ข ุณุชุชููู ููุงููุฉ ูู ุฃูู ุณููุจู ุฑุญูุชู</p>
                        <p>โฑ๏ธ ุฌุงุฑู ุงูุจุญุซ ุนู ุณุงุฆู...</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- ุญุงูุฉ ุทูุจ ุงูุฑุญูุฉ -->
        <div class="request-status-overlay" id="requestStatus" style="display: none;">
            <div class="status-content">
                <div class="status-icon">๐</div>
                <h3>ุฌุงุฑู ุงูุจุญุซ ุนู ุณุงุฆู</h3>
                <div class="status-details">
                    <p>ุฌุงุฑู ุงูุจุญุซ ูู ูุทุงู <span id="searchRadius">20</span> ูู</p>
                    <p>ุงูุณุงุฆููู ุงููุชุงุญูู: <span id="availableDriversCount">0</span></p>
                    <div class="searching-animation">
                        <div class="searching-dot"></div>
                        <div class="searching-dot"></div>
                        <div class="searching-dot"></div>
                    </div>
                </div>
                <button class="btn-danger" id="cancelRequestBtn">ุฅูุบุงุก ุงูุทูุจ</button>
            </div>
        </div>
    </div>

    <!-- ููุชุจุงุช JavaScript -->
    <script src="js/supabase-config.js"></script>
    <script src="js/geolocation.js"></script>
    <script src="js/map-service.js"></script>
    <script src="js/call-system.js"></script>
    <script src="js/enhanced-trip-system.js"></script>
    
    <!-- ุชุทุจูู ุตูุญุฉ ุทูุจ ุงูุฑุญูุฉ -->
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // ุชููุฆุฉ ุงูุฎุฑูุทุฉ
            const map = mapService.initMap('tripMap');
            
            // ุงูุญุตูู ุนูู ุงููููุน ุงูุญุงูู
            await initializeUserLocation();
            
            // ุฅุนุฏุงุฏ ูุณุชูุนู ุงูุฃุญุฏุงุซ
            setupEventListeners();
            
            // ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู
            updateUI();
        });

        async function initializeUserLocation() {
            const statusElement = document.getElementById('locationStatus');
            const statusText = document.getElementById('locationStatusText');
            const accuracyElement = document.getElementById('accuracyValue');
            
            try {
                // ูุญุงููุฉ ุงูุญุตูู ุนูู ุงููููุน
                const location = await geolocation.getCurrentLocation();
                
                // ุชุญุฏูุซ ุญุงูุฉ ุงููููุน
                statusElement.className = 'location-status accurate';
                statusText.textContent = 'ุชู ุชุญุฏูุฏ ูููุนู ุจูุฌุงุญ';
                accuracyElement.textContent = Math.round(location.accuracy);
                
                // ุชุญุฏูุซ ุงูุฎุฑูุทุฉ
                mapService.setUserLocation(location.lat, location.lng);
                
                // ุชุญุฏูุซ ุญูู ุงููููุน
                document.getElementById('pickupInput').value = 'ูููุนู ุงูุญุงูู';
                
                // ุชูููู ุฒุฑ ุทูุจ ุงูุฑุญูุฉ ุฅุฐุง ูุงูุช ุงููุฌูุฉ ูุญุฏุฏุฉ
                checkIfReadyToRequest();
                
            } catch (error) {
                // ูู ุญุงูุฉ ุงููุดูุ ุงุณุชุฎุฏุงู ูููุน ุงูุชุฑุงุถู
                statusElement.className = 'location-status error';
                statusText.textContent = 'ุชุนุฐุฑ ุชุญุฏูุฏ ุงููููุน. ุงุณุชุฎุฏู ุงูุฎุฑูุทุฉ ูุฏููุงู';
                
                // ุงุณุชุฎุฏุงู ูููุน ุงูุชุฑุงุถู (ุงูุฎุฑุทูู)
                const defaultLocation = { lat: 15.5007, lng: 32.5599, accuracy: 1000 };
                mapService.setUserLocation(defaultLocation.lat, defaultLocation.lng);
                
                // ุชูููู ุงูุงุฎุชูุงุฑ ุงููุฏูู
                document.getElementById('selectOnMapBtn').style.display = 'block';
            }
        }

        function setupEventListeners() {
            // ุฒุฑ ุชุญุฏูุฏ ุงููููุน ุงูุญุงูู
            document.getElementById('locateMeBtn').addEventListener('click', async () => {
                await initializeUserLocation();
            });

            // ุงูุจุญุซ ุนู ูุฌูุฉ
            document.getElementById('destinationInput').addEventListener('input', async (e) => {
                await searchDestination(e.target.value);
            });

            // ุงุฎุชูุงุฑ ููุน ุงูุณูุงุฑุฉ
            document.querySelectorAll('.car-option').forEach(option => {
                option.addEventListener('click', function() {
                    // ุฅุฒุงูุฉ ุงููุดุงุท ูู ุฌููุน ุงูุฎูุงุฑุงุช
                    document.querySelectorAll('.car-option').forEach(opt => {
                        opt.classList.remove('active');
                    });
                    
                    // ุฅุถุงูุฉ ุงููุดุงุท ููุฎูุงุฑ ุงููุญุฏุฏ
                    this.classList.add('active');
                    
                    // ุชุญุฏูุซ ุงูุณุนุฑ
                    updateTripPrice();
                });
            });

            // ุทูุจ ุงูุฑุญูุฉ
            document.getElementById('requestTripBtn').addEventListener('click', async () => {
                await requestTrip();
            });

            // ุฅูุบุงุก ุงูุทูุจ
            document.getElementById('cancelRequestBtn').addEventListener('click', () => {
                cancelTripRequest();
            });

            // ุนูุฏ ุงูููุฑ ุนูู ุงูุฎุฑูุทุฉ ูุงุฎุชูุงุฑ ูุฌูุฉ
            if (mapService.map) {
                mapService.map.on('click', async (e) => {
                    await selectDestinationOnMap(e.latlng);
                });
            }
        }

        async function searchDestination(query) {
            if (query.length < 3) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }

            const results = await mapService.searchLocation(query);
            displaySearchResults(results);
        }

        function displaySearchResults(results) {
            const resultsList = document.getElementById('resultsList');
            const searchResults = document.getElementById('searchResults');
            
            if (!results.length) {
                resultsList.innerHTML = '<div class="no-results">ูุง ุชูุฌุฏ ูุชุงุฆุฌ</div>';
                searchResults.style.display = 'block';
                return;
            }

            resultsList.innerHTML = results.map(result => `
                <div class="result-item" data-lat="${result.lat}" data-lng="${result.lng}">
                    <div class="result-icon">๐</div>
                    <div class="result-content">
                        <div class="result-name">${result.display_name}</div>
                        <div class="result-type">${result.type}</div>
                    </div>
                </div>
            `).join('');

            // ุฅุถุงูุฉ ูุณุชูุนู ุงูุฃุญุฏุงุซ ููุชุงุฆุฌ ุงูุจุญุซ
            document.querySelectorAll('.result-item').forEach(item => {
                item.addEventListener('click', function() {
                    const lat = parseFloat(this.dataset.lat);
                    const lng = parseFloat(this.dataset.lng);
                    selectDestination(lat, lng, this.querySelector('.result-name').textContent);
                });
            });

            searchResults.style.display = 'block';
        }

        async function selectDestination(lat, lng, address) {
            // ุชุญุฏูุซ ุญูู ุงููุฌูุฉ
            document.getElementById('destinationInput').value = address;
            
            // ุฅุฎูุงุก ูุชุงุฆุฌ ุงูุจุญุซ
            document.getElementById('searchResults').style.display = 'none';
            
            // ุชุญุฏูุซ ุงูุฎุฑูุทุฉ
            mapService.setDestination(lat, lng, address);
            
            // ุญุณุงุจ ุงููุณุงูุฉ ูุงูุชูููุฉ
            await calculateTripDetails(lat, lng);
            
            // ุชูููู ุฒุฑ ุทูุจ ุงูุฑุญูุฉ
            checkIfReadyToRequest();
        }

        async function selectDestinationOnMap(latlng) {
            // ุงูุญุตูู ุนูู ุนููุงู ูู ุงูุฅุญุฏุงุซูุงุช
            const address = await mapService.reverseGeocode(latlng.lat, latlng.lng);
            
            if (address) {
                await selectDestination(latlng.lat, latlng.lng, address.address);
            }
        }

        async function calculateTripDetails(destLat, destLng) {
            // ุงูุญุตูู ุนูู ูููุน ุงููุณุชุฎุฏู
            const userLocation = geolocation.userLocation;
            if (!userLocation) return;

            // ุญุณุงุจ ุงููุณุงูุฉ
            const distance = geolocation.calculateDistance(
                userLocation.lat, userLocation.lng,
                destLat, destLng
            );

            // ุญุณุงุจ ุงูููุช (ุงูุชุฑุงุถู: 2 ุฏูููุฉ ููู ูู)
            const duration = Math.round(distance * 2);

            // ุญุณุงุจ ุงูุชูููุฉ
            const selectedCar = document.querySelector('.car-option.active').dataset.type;
            const basePrice = getCarPrice(selectedCar);
            const fare = calculateFare(distance, basePrice);

            // ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู
            document.getElementById('tripDistance').textContent = distance.toFixed(1) + ' ูู';
            document.getElementById('tripDuration').textContent = duration + ' ุฏูููุฉ';
            document.getElementById('tripFare').textContent = fare.toLocaleString() + ' SDG';
            document.getElementById('finalFare').textContent = fare.toLocaleString();

            // ุฅุธูุงุฑ ูุนูููุงุช ุงูุฑุญูุฉ
            document.getElementById('tripInfo').style.display = 'block';
        }

        function getCarPrice(carType) {
            const prices = {
                'standard': 3000,
                'comfort': 4500,
                'van': 6000
            };
            return prices[carType] || 3000;
        }

        function calculateFare(distance, basePrice) {
            // ุณุนุฑ ุฃุณุงุณู + ุณุนุฑ ููู ูู
            const perKmPrice = 500; // 500 SDG ููู ูู
            return basePrice + (distance * perKmPrice);
        }

        function updateTripPrice() {
            const selectedCar = document.querySelector('.car-option.active').dataset.type;
            const basePrice = getCarPrice(selectedCar);
            
            // ุฅุฐุง ูุงูุช ููุงู ูุณุงูุฉ ูุญุฏุฏุฉุ ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุณุนุฑ
            const distanceElement = document.getElementById('tripDistance');
            if (distanceElement.textContent !== '-- ูู') {
                const distance = parseFloat(distanceElement.textContent);
                const fare = calculateFare(distance, basePrice);
                document.getElementById('finalFare').textContent = fare.toLocaleString();
            }
        }

        function checkIfReadyToRequest() {
            const pickup = document.getElementById('pickupInput').value;
            const destination = document.getElementById('destinationInput').value;
            const requestBtn = document.getElementById('requestTripBtn');
            
            if (pickup && destination) {
                requestBtn.disabled = false;
            } else {
                requestBtn.disabled = true;
            }
        }

        async function requestTrip() {
            const session = localStorage.getItem('travel_session');
            if (!session) {
                alert('ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู');
                window.location.href = 'login.html';
                return;
            }

            // ุงูุญุตูู ุนูู ุจูุงูุงุช ุงูุฑุญูุฉ
            const pickup = geolocation.userLocation;
            const destinationInput = document.getElementById('destinationInput').value;
            const selectedCar = document.querySelector('.car-option.active').dataset.type;

            if (!pickup) {
                alert('ูุฌุจ ุชุญุฏูุฏ ูููุน ุงูุงูุทูุงู ุฃููุงู');
                return;
            }

            // ุฅุธูุงุฑ ูุงูุฐุฉ ุงูุจุญุซ ุนู ุณุงุฆู
            document.getElementById('requestStatus').style.display = 'flex';
            
            try {
                // ุทูุจ ุงูุฑุญูุฉ
                const result = await enhancedTripSystem.requestTrip(
                    pickup,
                    { lat: 15.5007, lng: 32.5599 }, // ูููุน ุงูุชุฑุงุถู ูููุฌูุฉ
                    selectedCar
                );

                if (result.success) {
                    // ุงูุงูุชุธุงุฑ ุญุชู ูุชู ูุจูู ุงูุฑุญูุฉ
                    await waitForDriverAcceptance(result.trip.id);
                } else {
                    alert(result.error);
                    document.getElementById('requestStatus').style.display = 'none';
                }
                
            } catch (error) {
                console.error('Error requesting trip:', error);
                alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุทูุจ ุงูุฑุญูุฉ');
                document.getElementById('requestStatus').style.display = 'none';
            }
        }

        function cancelTripRequest() {
            document.getElementById('requestStatus').style.display = 'none';
            // ููุง ููููู ุฅุถุงูุฉ ููุทู ูุฅูุบุงุก ุงูุทูุจ ูู ุงููุธุงู
        }

        async function waitForDriverAcceptance(tripId) {
            // ุงูุงุณุชูุงุน ููุจูู ุงูุฑุญูุฉ
            // ูุฐุง ูุซุงู ูุจุณุทุ ูู ุงููุงูุน ุชุญุชุงุฌ ูุชูููุฐ WebSocket
            setTimeout(() => {
                // ูุญุงูุงุฉ ูุจูู ุงูุฑุญูุฉ ุจุนุฏ 15 ุซุงููุฉ
                simulateDriverAcceptance(tripId);
            }, 15000);
        }

        function simulateDriverAcceptance(tripId) {
            // ูุญุงูุงุฉ ูุจูู ุงูุฑุญูุฉ
            document.getElementById('requestStatus').innerHTML = `
                <div class="status-content">
                    <div class="status-icon success">โ</div>
                    <h3>ุชู ุงูุนุซูุฑ ุนูู ุณุงุฆู!</h3>
                    <div class="status-details">
                        <p>ุงุณู ุงูุณุงุฆู: ูุญูุฏ ุฃุญูุฏ</p>
                        <p>ููุน ุงูุณูุงุฑุฉ: ุชูููุชุง ูุงูุฑู</p>
                        <p>ุงูุฑูู: 0912345678</p>
                    </div>
                    <button class="btn-primary" onclick="goToTripView('${tripId}')">
                        ุนุฑุถ ุชูุงุตูู ุงูุฑุญูุฉ
                    </button>
                </div>
            `;
        }

        function goToTripView(tripId) {
            window.location.href = `trip-view.html?id=${tripId}`;
        }

        function updateUI() {
            // ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู ุจุดูู ุฏูุฑู
            setInterval(() => {
                // ุชุญุฏูุซ ุนุฏุฏ ุงูุณุงุฆููู ุงููุชุงุญูู
                updateAvailableDrivers();
            }, 10000);
        }

        async function updateAvailableDrivers() {
            // ูุญุงูุงุฉ ุชุญุฏูุซ ุนุฏุฏ ุงูุณุงุฆููู
            const randomCount = Math.floor(Math.random() * 5) + 1;
            document.getElementById('availableDriversCount').textContent = randomCount;
        }
    </script>
</body>
</html>