<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head><link rel="manifest" href="/manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="/assets/icon-192.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ±Ø­Ø§Ù„ Ø§Ù„Ø³ÙˆØ¯Ø§Ù† - ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</title>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f7f6; }
        .init-container { max-width: 800px; margin: 50px auto; padding: 20px; }
        .card { background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        .step-item { display: flex; align-items: center; background: #fff; padding: 15px; margin: 10px 0; border-radius: 8px; border-right: 5px solid #ddd; }
        .step-item.success { border-right-color: #28a745; background: #f0fff4; }
        .step-item.loading { border-right-color: #ffc107; background: #fffdf0; }
        .step-item.error { border-right-color: #dc3545; background: #fff5f5; }
        .btn-start { background: #667eea; color: white; padding: 12px 30px; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; margin-top: 20px; display: none; }
    </style>
</head>
<body>

    <div class="init-container">
        <div class="card">
            <h1>ğŸš— ØªØ±Ø­Ø§Ù„ Ø§Ù„Ø³ÙˆØ¯Ø§Ù†</h1>
            <p>Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø®Ø¯Ù…Ø§Øª...</p>
            
            <div id="steps">
                <div id="step1" class="step-item loading">
                    <span>1. Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase</span>
                </div>
                <div id="step2" class="step-item">
                    <span>2. Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ JSONBin</span>
                </div>
                <div id="step3" class="step-item">
                    <span>3. Ù…Ø²Ø§Ù…Ù†Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ†</span>
                </div>
            </div>

            <button id="btnMain" class="btn-start" onclick="window.location.href='index-main.html'">
                Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù… ğŸš€
            </button>
        </div>
    </div>

    <script src="js/supabase-config.js"></script>
    <script src="js/initialize-jsonbin.js"></script>
    <script src="js/geolocation.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("ğŸš€ Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ÙØ­Øµ...");

            try {
                // 1. ÙØ­Øµ Supabase
                updateUI(1, 'loading');
                const isDBConnected = await testConnection();
                if(isDBConnected) updateUI(1, 'success');

                // 2. ÙØ­Øµ JSONBin
                updateUI(2, 'loading');
                const binData = await window.getJSONBin();
                if(binData) updateUI(2, 'success');

                // 3. Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© ÙˆØ§Ù„Ø¨Ø¯Ø¡
                updateUI(3, 'loading');
                // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ­Ù…ÙŠÙ„ Ø¨Ø³ÙŠØ·
                setTimeout(() => {
                    updateUI(3, 'success');
                    document.getElementById('btnMain').style.display = 'inline-block';
                }, 1500);

            } catch (error) {
                console.error("Initialization error:", error);
            }
        });

        async function testConnection() {
            try {
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… window.supabaseClient Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¹Ø±Ù ÙÙŠ Ø§Ù„ØªÙˆØµÙŠÙ
                const { data, error } = await window.supabaseClient
                    .from('drivers') 
                    .select('*')
                    .limit(1);
                
                if (error) throw error;
                return true;
            } catch (err) {
                const step1 = document.getElementById('step1');
                step1.className = 'step-item error';
                step1.innerHTML += ` <small>(${err.message})</small>`;
                return false;
            }
        }

        function updateUI(step, status) {
            const el = document.getElementById(`step${step}`);
            el.className = `step-item ${status}`;
        }
    </script>
<script>
// ØªØ³Ø¬ÙŠÙ„ Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js')
      .then(reg => console.log('âœ… Service Worker Registered'))
      .catch(err => console.error('âŒ SW Registration Failed', err));
  });
}

// Ø¯Ø§Ù„Ø© ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Supabase (Ù…Ø­Ø¯Ø«Ø©)
async function testConnection() {
    try {
        // ÙØ­Øµ Ù…Ø¨Ø§Ø´Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… window.supabaseClient Ø§Ù„Ù…Ø¹Ø±Ù ÙÙŠ supabase-config.js
        const { data, error } = await window.supabaseClient
            .from('drivers') 
            .select('id')
            .limit(1);
        
        if (error) throw error;
        return true;
    } catch (err) {
        console.error("Connection Error:", err.message);
        return false;
    }
}
</script>
</body>
</html>
